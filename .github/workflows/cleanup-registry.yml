name: Cleanup Container Registry

on:
  # Immediate cleanup when PR is closed (merged or declined)
  pull_request:
    types: [closed]
  # Scheduled cleanup as safety net
  schedule:
    - cron: '0 3 * * *'  # Daily at 3 AM UTC
  workflow_dispatch:

env:
  IMAGE_NAME: myproject-api

jobs:
  # Cleanup specific PR images when PR is closed
  cleanup-pr:
    name: Cleanup PR Images
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      packages: write

    steps:
      - name: Delete PR images
        # v3.0.1
        uses: snok/container-retention-policy@3b0972b2276b171b212f8c4efbca59ebba26eceb
        with:
          account: ${{ github.repository_owner }}
          token: ${{ secrets.GITHUB_TOKEN }}
          image-names: ${{ github.event.repository.name }}/${{ env.IMAGE_NAME }}
          tag-selection: tagged
          filter-tags: 'pr-${{ github.event.pull_request.number }}*'
          keep-n-most-recent: 0

  # Scheduled bulk cleanup
  cleanup-scheduled:
    name: Scheduled Cleanup
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      packages: write

    steps:
      - name: Cleanup main branch images (keep last 5)
        # v3.0.1
        uses: snok/container-retention-policy@3b0972b2276b171b212f8c4efbca59ebba26eceb
        with:
          account: ${{ github.repository_owner }}
          token: ${{ secrets.GITHUB_TOKEN }}
          image-names: ${{ github.event.repository.name }}/${{ env.IMAGE_NAME }}
          tag-selection: tagged
          filter-tags: 'main-*'
          keep-n-most-recent: 5

      - name: Cleanup orphaned PR images (keep last 20 total)
        # v3.0.1 - Catches any PR images missed by event-based cleanup
        uses: snok/container-retention-policy@3b0972b2276b171b212f8c4efbca59ebba26eceb
        with:
          account: ${{ github.repository_owner }}
          token: ${{ secrets.GITHUB_TOKEN }}
          image-names: ${{ github.event.repository.name }}/${{ env.IMAGE_NAME }}
          tag-selection: tagged
          filter-tags: 'pr-*'
          keep-n-most-recent: 20

      # ─────────────────────────────────────────────────────────────────────────
      # Orphaned Architecture-Specific Manifest Cleanup
      # ─────────────────────────────────────────────────────────────────────────
      # Native multi-arch builds (matrix strategy) push arch-specific images
      # by digest (untagged), then merge them into a tagged manifest list.
      #
      # Orphaned manifests can occur when:
      # 1. A build fails after pushing arch images but before manifest merge
      # 2. A tagged manifest list is deleted (arch manifests become orphaned)
      #
      # This step removes all untagged manifests, cleaning up:
      # - Orphaned linux/amd64 and linux/arm64 arch-specific images
      # - Any other intermediate build artifacts
      # ─────────────────────────────────────────────────────────────────────────
      - name: Cleanup untagged manifests
        # v3.0.1
        uses: snok/container-retention-policy@3b0972b2276b171b212f8c4efbca59ebba26eceb
        with:
          account: ${{ github.repository_owner }}
          token: ${{ secrets.GITHUB_TOKEN }}
          image-names: ${{ github.event.repository.name }}/${{ env.IMAGE_NAME }}
          tag-selection: untagged
          keep-n-most-recent: 0
