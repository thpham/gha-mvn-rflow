name: Backport

# Justification for pull_request_target: Required for backport action to have write permissions
# to create branches and PRs. Risk is mitigated by:
# 1. Only running on merged PRs from the same repository (not forks)
# 2. The backport action doesn't execute untrusted PR code
# Note: persist-credentials must be true for the backport action to push branches
on: # zizmor: ignore[dangerous-triggers]
  pull_request_target:
    types: [closed]

permissions:
  contents: write
  pull-requests: write

jobs:
  backport:
    name: Backport PR
    runs-on: ubuntu-latest
    # Only run on merged PRs from the same repository (not forks)
    if: |
      github.event.pull_request.merged == true &&
      github.event.pull_request.head.repo.full_name == github.repository

    steps:
      - name: Checkout
        # v6
        # zizmor: ignore[artipacked] - persist-credentials must be true for backport action to push branches
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          fetch-depth: 0

      - name: Backport Action
        # v3
        uses: korthout/backport-action@c656f5d5851037b2b38fb5db2691a03fa229e3b2
        id: backport
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          label_pattern: "^backport ([^ ]+)$"
          pull_description: |
            Backport of #${pull_number} to `${target_branch}`.

            ---

            ${pull_description}

      # Check if target branch has SNAPSHOT version - warn if not
      - name: Check SNAPSHOT Version
        if: steps.backport.outputs.created_pull_numbers != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CREATED_PRS: ${{ steps.backport.outputs.created_pull_numbers }}
        run: |
          for pr_number in $(echo "${CREATED_PRS}" | tr ',' ' '); do
            # Get the target branch of the created PR
            target_branch=$(gh pr view "${pr_number}" --json baseRefName -q '.baseRefName')

            # Get the version from the target branch's pom.xml
            version=$(gh api "repos/${GITHUB_REPOSITORY}/contents/pom.xml?ref=${target_branch}" \
              -q '.content' | base64 -d | grep -oP '(?<=<version>)[^<]+' | head -1)

            if [[ "${version}" != *-SNAPSHOT ]]; then
              echo "::warning::PR #${pr_number} targets ${target_branch} which has version ${version} (not SNAPSHOT). Wait for version bump before merging!"

              # Add a comment to the PR warning about this
              gh pr comment "${pr_number}" --body "$(cat <<'EOF'
          ⚠️ **Warning**: Target branch has a non-SNAPSHOT version.

          Please wait for the SNAPSHOT version bump PR to be merged before merging this backport PR. Merging before the version bump may cause version conflicts.

          The SNAPSHOT bump PR should be auto-merged shortly after the release.
          EOF
              )"
            else
              echo "✓ PR #${pr_number} targets ${target_branch} with SNAPSHOT version ${version}"
            fi
          done
