name: Backport

# Justification for pull_request_target: Required for backport action to have write permissions
# to create branches and PRs. Risk is mitigated by:
# 1. Only running on merged PRs from the same repository (not forks)
# 2. Using persist-credentials: false on checkout
# 3. The backport action doesn't execute untrusted PR code
on: # zizmor: ignore[dangerous-triggers]
  pull_request_target:
    types: [closed]

permissions:
  contents: write
  pull-requests: write

jobs:
  backport:
    name: Backport PR
    runs-on: ubuntu-latest
    # Only run on merged PRs from the same repository (not forks)
    if: |
      github.event.pull_request.merged == true &&
      github.event.pull_request.head.repo.full_name == github.repository

    steps:
      - name: Checkout
        # v4
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Backport Action
        # v3
        uses: korthout/backport-action@d07416681cab29bf2661702f925f020aaa962997
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          label_pattern: '^backport ([^ ]+)$'
          pull_description: |
            Backport of #${pull_number} to `${target_branch}`.

            ---

            ${pull_description}
