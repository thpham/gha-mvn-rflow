// Grafana Alloy configuration for local development
// OpenTelemetry-native collector that scrapes Prometheus metrics and forwards to Mimir

// ============================================================================
// Prometheus Scraping
// ============================================================================

// Scrape Spring Boot application metrics
prometheus.scrape "myproject_api" {
  targets = [{
    __address__ = "host.docker.internal:8080",
  }]
  metrics_path = "/actuator/prometheus"
  scrape_interval = "10s"
  forward_to = [prometheus.remote_write.mimir.receiver]
}

// Scrape Tempo metrics for service graphs
prometheus.scrape "tempo" {
  targets = [{
    __address__ = "tempo:3200",
  }]
  scrape_interval = "15s"
  forward_to = [prometheus.remote_write.mimir.receiver]
}

// Scrape Mimir metrics
prometheus.scrape "mimir" {
  targets = [{
    __address__ = "mimir:9009",
  }]
  scrape_interval = "15s"
  forward_to = [prometheus.remote_write.mimir.receiver]
}

// Scrape Loki metrics
prometheus.scrape "loki" {
  targets = [{
    __address__ = "loki:3100",
  }]
  scrape_interval = "15s"
  forward_to = [prometheus.remote_write.mimir.receiver]
}

// Scrape Alloy's own metrics
prometheus.scrape "alloy" {
  targets = [{
    __address__ = "localhost:12345",
  }]
  scrape_interval = "15s"
  forward_to = [prometheus.remote_write.mimir.receiver]
}

// ============================================================================
// Remote Write to Mimir
// ============================================================================

prometheus.remote_write "mimir" {
  endpoint {
    url = "http://mimir:9009/api/v1/push"
    send_exemplars = true
  }
  external_labels = {
    cluster = "local",
    environment = "development",
  }
}

// ============================================================================
// Logging (optional - for debugging)
// ============================================================================

logging {
  level = "info"
  format = "logfmt"
}
